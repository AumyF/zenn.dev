---
title: "Nixを知ってほしい"
topics: [Nix]
type: tech
emoji: ❄
published: false
---

# この記事を書いた理由

Nix を流行らせて、みなさんが依存パッケージで苦しまなくてもいいようにするためです。

Nix はかなり良いツールなのですが、能力が多面的すぎて初見で「これは何なのか、何ができるのか」という全貌を把握することが困難であるため、この記事を読めばわかるようにしたいと思って書いています。

# Nix とは何か

Nix は Linux, macOS^[Unix-like な OS のことを *nix と表現する人はそれなりに多いが、ほとんどの検索システムで Nix との混線が発生するので個人的にはやめてほしい] で利用可能なパッケージマネージャ/ビルドシステムです。公式サイトである [nixos.org](https://nixos.org/) には Nix の大きな特徴として以下の 3 つが挙げられています。

- Reproducible (再現可能)
  - Nix はパッケージのビルドを隔離された環境で行うため、パッケージは暗黙的な依存関係を持ちません。結果的に、あるパッケージがあるマシンで動作したなら、他のマシンでも同様に問題なく動くことが保証されます。
- Declarative (宣言的)
  - たとえば、ビルドに必要なパッケージを `apt install` で手続き的に導入する必要はなく、パッケージ名のリストを依存関係として指定するだけで導入できます^[裏側でゴリゴリにシェルスクリプトが動いている場合がまれによくあり、完全に手続きから逃れられるわけではないが、エコシステムがよく整備されている使い方なら宣言的一本で問題ない]。
- Reliable (信頼可能)
  - Nix では同じソフトウェアの異なるバージョンを別々に管理するため、たとえば「ソフトウェアをアップグレードしたらそれに依存していた他のパッケージが壊れた」というようなことは起きません。

Nix は Node.js でいう nvm, Volta, nodenv, fnm、Rust でいう rustup、Ruby でいう rbenv のようなツールチェインマネージャとして使うこともできます。`shell.nix` というファイルで `nodejs` `ghc` `haskell-language-server` などプロジェクトで使うツールを指定して、`nix-shell` というコマンドを打つと、指定したパッケージが利用可能なシェルに入ることができます。これは asdf に似ていますが、Nix のパッケージレジストリにあるツールなら何でも指定できるというのが Nix の強みです。direnv というツールを併用すれば `nix-shell` を叩く必要すらなく、ディレクトリにエントリーするだけで勝手にいい感じにツールが揃ったシェルが開かれます。

Nix は Homebrew や apt を代替するパッケージマネージャとしても優れています。Nix においては実際のソフトウェアは Nix Store とよばれる場所^[基本的に `/nix/store`]に存在し、それらのうち PATH を通す (実際に使う) ものを profile という形で指定します。Nix の CLI においてパッケージをアンインストールする `nix-env -e` はパッケージをプロファイルから除去するのみで、Nix Store からは削除しません。そのため、`nix-env --rollback` というコマンドを打つだけで簡単にアンインストール前の状態に戻すことができます。アップグレードにおいても同様で、元のバージョンは Nix Store に残ったまま、新しいバージョンが profile に表出します。

Nix は C/C++, Rust, .NET, OCaml, Node.js, Nim, Haskell などさまざまなプログラミング言語のプロジェクトに対して使用でき、それぞれのエコシステムがもつパッケージマネージャやビルドシステムを包括するメタ性を持っています。Nix で Dockerfile なしに Docker コンテナをビルドすることもできます。

Nix をシステムのパッケージマネージャとして使う NixOS という Linux ディストリビューションも存在します。NixOS ではシステムの設定も Nix Expression を使って宣言的かつ再現可能な形で記述でき、間違った設定でシステムを破壊してしまった時もブートメニューから簡単に以前の設定に差し戻すことができます。NixOS のような宣言的システム管理は nix-darwin, home-manager といったツールを使うことで macOS や NixOS 以外の Linux ディストリビューションでも簡易的に行うことができます^[NixOS は VMWare など一部のソフトウェアとしての食い合わせが悪いらしい、nix-darwin や home-manager は完全に Nix 化できるわけではないなど欠点も存在し、万人向けではない]。

などなど、Nix は段階に応じていろいろな使い方ができる、可能性に満ちたソフトウェアです。

# 使ってみる

## インストール

以下のコマンドを打つことで導入します。`sudo` を使用します。

```shell
bash <(curl -L https://nixos.org/nix/install)
```

## 基礎的なパッケージ管理

`nix-env` は現在使用しているプロファイルを編集するコマンドです。

### パッケージを検索

パッケージの一覧表示や検索には `--query` もしくは省略形の `-q` を使います。

インストール可能なすべてのパッケージを表示するには `nix-env -qa` を使います^[おそらく毎回大量の Nix Expression を評価しなおしているため、このコマンドを実行するのにはかなりの時間がかかる]。

```
nix-env -qa
```

引数としてパッケージ名を渡すと検索もできます。

### パッケージをインストール

プロファイルにパッケージをインストールするには `--install` もしくは `-i` を使います^[もろもろの事情により、`-i node` より `-iA nixpkgs.node` のほうが圧倒的に高速]。

```
nix-env -iA nixpkgs.nodejs
```

`nixpkgs` からパッケージをインストールするときにはバイナリキャッシュという仕組みでビルド済みバイナリが直接降ってくるため、いちいちビルドが走ることはありません。

`node` が動作することを確かめます。

```shell
which node
```

`~/.nix-profile/bin/node` にあることがわかると思います。これはシンボリックリンクになっているので、辿ってみましょう。

```shell
readlink ~/.nix-profile/bin/node
```

```
nix-env -q
```

## 開発環境をセットアップ
